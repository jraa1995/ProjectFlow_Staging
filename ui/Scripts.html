<script>
  const $ = (id) => document.getElementById(id);
  const $$ = (selector) => document.querySelectorAll(selector);
  const LocalCache = {
    prefix: 'pf_',
    get(key) {
      try {
        const item = localStorage.getItem(this.prefix + key);
        if (!item) return null;
        const parsed = JSON.parse(item);
        if (parsed.expires && Date.now() > parsed.expires) {
          this.remove(key);
          return null;
        }
        return parsed.data;
      } catch (e) {
        return null;
      }
    },
    set(key, data, ttlMinutes = 60) {
      try {
        const item = {
          data,
          expires: Date.now() + (ttlMinutes * 60 * 1000),
          timestamp: Date.now()
        };
        localStorage.setItem(this.prefix + key, JSON.stringify(item));
      } catch (e) {
        console.warn('LocalCache set failed:', e);
      }
    },
    remove(key) {
      localStorage.removeItem(this.prefix + key);
    },
    clear() {
      Object.keys(localStorage)
        .filter(k => k.startsWith(this.prefix))
        .forEach(k => localStorage.removeItem(k));
    }
  };
  const OptimisticUI = {
    pendingOps: new Map(),
    opId: 0,
    generateOpId() {
      return `op_${++this.opId}_${Date.now()}`;
    },
    apply(opType, data, domUpdate, stateUpdate, apiCall) {
      const opId = this.generateOpId();
      const snapshot = this.createSnapshot(opType, data);
      domUpdate();
      stateUpdate();
      this.pendingOps.set(opId, {
        opType,
        data,
        snapshot,
        status: 'pending'
      });
      this.showPendingIndicator(data.taskId || data.id);
      apiCall()
        .then((result) => {
          this.pendingOps.delete(opId);
          this.hidePendingIndicator(data.taskId || data.id);
          if (result?.version) {
            SyncManager.setVersion(result.version);
          }
        })
        .catch((error) => {
          console.error(`❌ ${opType} failed, reverting:`, error);
          this.revert(opId);
          this.pendingOps.delete(opId);
          this.hidePendingIndicator(data.taskId || data.id);
          toast(`Failed to ${opType}: ${error.message || 'Unknown error'}`, 'error');
        });
      return opId;
    },
    createSnapshot(opType, data) {
      switch (opType) {
        case 'moveTask':
          const task = State.tasks?.find(t => t.id === data.taskId);
          return {
            status: task?.status, position: task?.position
          };
        case 'updateTask':
          const taskToUpdate = State.tasks?.find(t => t.id === data.taskId);
          return taskToUpdate ? {
            ...taskToUpdate
          } : null;
        case 'createTask':
          return {
            taskId: data.taskId
          };
        case 'deleteTask':
          return State.tasks?.find(t => t.id === data.taskId);
        default:
          return null;
      }
    },
    revert(opId) {
      const op = this.pendingOps.get(opId);
      if (!op || !op.snapshot) return;
      switch (op.opType) {
        case 'moveTask':
          this.revertMoveTask(op.data.taskId, op.snapshot.status);
          break;
        case 'updateTask':
          this.revertUpdateTask(op.data.taskId, op.snapshot);
          break;
        case 'createTask':
          this.revertCreateTask(op.data.taskId);
          break;
        case 'deleteTask':
          this.revertDeleteTask(op.snapshot);
          break;
      }
    },
    revertMoveTask(taskId, previousStatus) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card && previousStatus) {
        const targetColumn = document.querySelector(`.task-list[data-status="${previousStatus}"]`);
        if (targetColumn) {
          targetColumn.appendChild(card);
          card.dataset.status = previousStatus;
        }
      }
      if (State.tasks) {
        const task = State.tasks.find(t => t.id === taskId);
        if (task) task.status = previousStatus;
      }
      updateColumnCounts();
    },
    revertUpdateTask(taskId, snapshot) {
      if (State.tasks) {
        const idx = State.tasks.findIndex(t => t.id === taskId);
        if (idx >= 0) State.tasks[idx] = snapshot;
      }
      updateTaskInDOM(taskId, snapshot);
    },
    revertCreateTask(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card) card.remove();
      if (State.tasks) {
        State.tasks = State.tasks.filter(t => t.id !== taskId);
      }
      updateColumnCounts();
    },
    revertDeleteTask(snapshot) {
      if (snapshot && State.tasks) {
        State.tasks.push(snapshot);
      }
      loadBoard();
    },
    showPendingIndicator(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card) {
        card.classList.add('syncing');
        if (!card.querySelector('.sync-indicator')) {
          const indicator = document.createElement('div');
          indicator.className = 'sync-indicator';
          indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i>';
          card.appendChild(indicator);
        }
      }
    },
    hidePendingIndicator(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card) {
        card.classList.remove('syncing');
        const indicator = card.querySelector('.sync-indicator');
        if (indicator) indicator.remove();
      }
    },
    hasPendingOps() {
      return this.pendingOps.size > 0;
    },
    getPendingCount() {
      return this.pendingOps.size;
    }
  };
  const State = {
    user: null,
    board: null,
    projects: [],
    users: [],
    view: "my",
    projectFilter: null,
    loading: false,
    editingTask: null,
    draggedTask: null,
    currentView: "my",
    timelineData: null,
    analyticsData: null,
    config: null,
    cache: {
      tasks: {
        data: [],
        lastFetched: null,
        isFresh: false
      },
      projects: {
        data: [],
        lastFetched: null,
        isFresh: false
      },
      users: {
        data: [],
        lastFetched: null,
        isFresh: false
      }
    },
    cacheConfig: {
      ttl: 5 * 60 * 1000,
      maxAge: 30 * 60 * 1000
    },
    getTasks() {
      const cache = this.cache.tasks;
      if (!cache.isFresh || !cache.lastFetched) return null;
      const age = Date.now() - cache.lastFetched;
      if (age > this.cacheConfig.maxAge) {
        cache.isFresh = false;
        return null;
      }
      return cache.data;
    },
    setTasks(tasks) {
      this.cache.tasks = {
        data: tasks,
        lastFetched: Date.now(),
        isFresh: true
      };
      this.tasks = tasks;
    },
    getProjects() {
      const cache = this.cache.projects;
      if (!cache.isFresh || !cache.lastFetched) return null;
      const age = Date.now() - cache.lastFetched;
      if (age > this.cacheConfig.maxAge) {
        cache.isFresh = false;
        return null;
      }
      return cache.data;
    },
    setProjects(projects) {
      this.cache.projects = {
        data: projects,
        lastFetched: Date.now(),
        isFresh: true
      };
      this.projects = projects;
    },
    getUsers() {
      const cache = this.cache.users;
      if (!cache.isFresh || !cache.lastFetched) return null;
      const age = Date.now() - cache.lastFetched;
      if (age > this.cacheConfig.maxAge) {
        cache.isFresh = false;
        return null;
      }
      return cache.data;
    },
    setUsers(users) {
      this.cache.users = {
        data: users,
        lastFetched: Date.now(),
        isFresh: true
      };
      this.users = users;
    },
    invalidateCache() {
      this.cache.tasks.isFresh = false;
      this.cache.projects.isFresh = false;
      this.cache.users.isFresh = false;
    },
    hasFreshCache() {
      const tasks = this.getTasks();
      const projects = this.getProjects();
      const users = this.getUsers();
      return tasks !== null && projects !== null && users !== null;
    }
  };
  const RequestQueue = {
    pending: new Map(),
    debounceMs: 300,
    batchQueue: [],
    batchTimer: null,
    batchDelayMs: 100,
    enqueue(key, fn, debounce = true) {
      if (this.pending.has(key)) {
        clearTimeout(this.pending.get(key).timer);
      }
      if (debounce) {
        const timer = setTimeout(() => this.execute(key), this.debounceMs);
        this.pending.set(key, {
          fn,
          timer
        });
      } else {
        this.pending.set(key, {
          fn,
          timer: null
        });
        this.execute(key);
      }
    },
    execute(key) {
      const item = this.pending.get(key);
      if (item) {
        this.pending.delete(key);
        try {
          item.fn();
        } catch (error) {
          console.error(`Request ${key} failed:`, error);
        }
      }
    },
    cancel(key) {
      if (this.pending.has(key)) {
        clearTimeout(this.pending.get(key).timer);
        this.pending.delete(key);
      }
    },
    addToBatch(operation) {
      this.batchQueue.push(operation);
      if (this.batchTimer) {
        clearTimeout(this.batchTimer);
      }
      this.batchTimer = setTimeout(() => this.flushBatch(), this.batchDelayMs);
    },
    flushBatch() {
      if (this.batchQueue.length === 0) return;
      const operations = [...this.batchQueue];
      this.batchQueue = [];
      this.batchTimer = null;
      google.script.run
        .withSuccessHandler((results) => {
          results.results?.forEach((result, index) => {
            if (!result.success) {
              console.warn(`Batch operation ${index} failed:`, result.error);
            }
          });
        })
        .withFailureHandler((error) => {
          console.error('❌ Batch failed:', error);
          toast('Some operations failed. Please refresh.', 'error');
        })
        .executeBatchOperations(operations);
    },
    clear() {
      this.pending.forEach((item) => {
        if (item.timer) clearTimeout(item.timer);
      });
      this.pending.clear();
      if (this.batchTimer) {
        clearTimeout(this.batchTimer);
        this.batchTimer = null;
      }
      this.batchQueue = [];
    }
  };
  const SyncManager = {
    lastSyncVersion: 0,
    pollInterval: 30000,
    pollTimer: null,
    lastActivity: Date.now(),
    isEnabled: true,
    init() {
      ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
        document.addEventListener(event, () => this.markActive(), {
          passive: true
        });
      });
      this.startPolling();
    },
    markActive() {
      this.lastActivity = Date.now();
    },
    isUserActive() {
      return Date.now() - this.lastActivity < 60000;
    },
    startPolling() {
      if (this.pollTimer) {
        clearInterval(this.pollTimer);
      }
      this.pollTimer = setInterval(() => {
        if (this.isEnabled && this.isUserActive()) {
          this.checkForUpdates();
        }
      }, this.pollInterval);
    },
    stopPolling() {
      if (this.pollTimer) {
        clearInterval(this.pollTimer);
        this.pollTimer = null;
      }
    },
    checkForUpdates() {
      google.script.run
        .withSuccessHandler((result) => {
          if (result.version > this.lastSyncVersion) {
            if (result.changedIds.length > 0) {
              this.fetchChangedItems(result.changedIds);
            }
            this.lastSyncVersion = result.version;
          }
        })
        .withFailureHandler((error) => {
          console.warn('SyncManager checkForUpdates failed:', error);
        })
        .getChangesSince(this.lastSyncVersion);
    },
    fetchChangedItems(taskIds) {
      if (!taskIds || taskIds.length === 0) return;
      google.script.run
        .withSuccessHandler((tasks) => {
          tasks.forEach(task => {
            updateTaskInDOM(task.id, task);
            if (State.tasks) {
              const index = State.tasks.findIndex(t => t.id === task.id);
              if (index >= 0) {
                State.tasks[index] = task;
              } else {
                State.tasks.push(task);
              }
            }
          });
          updateColumnCounts();
        })
        .withFailureHandler((error) => {
          console.warn('SyncManager fetchChangedItems failed:', error);
        })
        .getTasksByIds(taskIds);
    },
    forceFullSync() {
      this.lastSyncVersion = 0;
      this.checkForUpdates();
    },
    setVersion(version) {
      if (version && version > this.lastSyncVersion) {
        this.lastSyncVersion = version;
      }
    }
  };
  async function loadAllData(forceRefresh = false) {
    if (State.loading) {
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (!State.loading) {
            clearInterval(checkInterval);
            resolve({
              tasks: State.cache.tasks.data,
              projects: State.cache.projects.data,
              users: State.cache.users.data
            });
          }
        }, 100);
      });
    }
    if (!forceRefresh && State.hasFreshCache()) {
      return {
        tasks: State.cache.tasks.data,
        projects: State.cache.projects.data,
        users: State.cache.users.data
      };
    }
    const localTasks = LocalCache.get('tasks');
    const localProjects = LocalCache.get('projects');
    const localUsers = LocalCache.get('users');
    const localBoard = LocalCache.get('board');
    if (!forceRefresh && localTasks && localProjects) {
      State.setTasks(localTasks);
      State.setProjects(localProjects);
      State.setUsers(localUsers || []);
      if (localBoard) {
        State.board = localBoard;
      }
      setTimeout(() => fetchFreshDataInBackground(), 100);
      return {
        tasks: localTasks,
        projects: localProjects,
        users: localUsers || []
      };
    }
    if (!forceRefresh && typeof CacheService !== 'undefined') {
      try {
        const [cachedTasks, cachedProjects, cachedUsers, cachedConfig] = await Promise.all([
          CacheService.get('tasks'),
          CacheService.get('projects'),
          CacheService.get('users'),
          CacheService.get('config')
        ]);
        if (cachedTasks && cachedProjects && cachedUsers) {
          State.setTasks(cachedTasks);
          State.setProjects(cachedProjects);
          State.setUsers(cachedUsers);
          LocalCache.set('tasks', cachedTasks);
          LocalCache.set('projects', cachedProjects);
          LocalCache.set('users', cachedUsers);
          if (cachedConfig) {
            State.config = cachedConfig;
            if (!State.board) State.board = {};
            State.board.config = cachedConfig;
          }
          setTimeout(() => fetchFreshDataInBackground(), 500);
          return {
            tasks: cachedTasks,
            projects: cachedProjects,
            users: cachedUsers
          };
        }
      } catch (cacheError) {
        console.warn('IndexedDB cache read failed, loading from server:', cacheError);
      }
    }
    State.loading = true;
    showLoading(true);
    try {
      const data = await new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getListViewData();
      });
      if (!data || !data.success) {
        throw new Error(data?.error || 'Failed to load data');
      }
      persistDataToAllCaches(data);
      showLoading(false);
      State.loading = false;
      tasks: data.tasks?.length || 0,
        projects: data.projects?.length || 0,
        users: data.users?.length || 0
    });
  return {
    tasks: data.tasks || [],
    projects: data.projects || [],
    users: data.users || []
  };
  }
  catch (error) {
    console.error('❌ Failed to load data:', error);
    showLoading(false);
    State.loading = false;
    toast('Failed to load data: ' + error.message, 'error');
    throw error;
  }
  }

  function persistDataToAllCaches(data) {
    State.setTasks(data.tasks || []);
    State.setProjects(data.projects || []);
    State.setUsers(data.users || []);
    LocalCache.set('tasks', data.tasks || []);
    LocalCache.set('projects', data.projects || []);
    LocalCache.set('users', data.users || []);
    if (typeof CacheService !== 'undefined') {
      Promise.all([
        CacheService.set('tasks', data.tasks || []),
        CacheService.set('projects', data.projects || []),
        CacheService.set('users', data.users || [])
      ]).catch(err => console.warn('Background cache persist failed:', err));
    }
  }

  function fetchFreshDataInBackground() {
    google.script.run
      .withSuccessHandler((data) => {
        if (!data || !data.success) {
          console.warn('Background fetch returned invalid data');
          return;
        }
        const currentTasks = State.cache.tasks.data || [];
        const currentUsers = State.cache.users.data || [];
        const newTasks = data.tasks || [];
        const newUsers = data.users || [];
        // Check for task changes
        const hasTaskChanges = currentTasks.length !== newTasks.length ||
          newTasks.some((t, i) => {
            const current = currentTasks.find(ct => ct.id === t.id);
            return !current || current.status !== t.status || current.title !== t.title;
          });
        // Check for user changes (always update users for fresh data)
        const hasUserChanges = currentUsers.length !== newUsers.length ||
          newUsers.some(u => {
            const current = currentUsers.find(cu => cu.email === u.email);
            return !current || current.name !== u.name || current.active !== u.active;
          });
        // Always update users to ensure fresh data
        if (hasUserChanges) {
          State.setUsers(newUsers);
          LocalCache.set('users', newUsers);
          if (typeof CacheService !== 'undefined') {
            CacheService.set('users', newUsers).catch(err => console.warn('User cache persist failed:', err));
          }
        }
        // Update tasks and re-render if changed
        if (hasTaskChanges) {
          persistDataToAllCaches(data);
          if (State.currentView === 'my' || State.currentView === 'master') {
            const projectId = State.projectFilter || null;
            const board = buildBoardFromTasks(newTasks, projectId);
            State.board = board;
            renderBoard();
            updateStats();
          }
        }
        if (!hasTaskChanges && !hasUserChanges) {}
      })
      .withFailureHandler((error) => {
        console.warn('Background fetch failed:', error);
      })
      .getListViewData();
  }

  function buildBoardFromTasks(allTasks, projectId) {
    const statuses = State.config?.statuses || ['Backlog', 'To Do', 'In Progress', 'Review', 'Testing', 'Done'];
    const colors = State.config?.colors || {};
    let tasks = allTasks;
    if (projectId) {
      tasks = tasks.filter(t => t.projectId === projectId);
    }
    if (State.view === 'my' && State.user?.email) {
      tasks = tasks.filter(t => t.assignee?.toLowerCase() === State.user.email.toLowerCase());
    }
    const columns = statuses.map((status, index) => {
      const normalizedId = status.toLowerCase().replace(/\s+/g, '_');
      const columnTasks = tasks.filter(t => t.status === status);
      return {
        id: normalizedId,
        name: status,
        color: colors[status] || '#6B7280',
        order: index,
        tasks: columnTasks,
        count: columnTasks.length
      };
    });
    return {
      columns,
      projects: State.projects,
      users: State.users,
      taskCount: tasks.length,
      config: State.config
    };
  }
  async function refreshAllData() {
    State.invalidateCache();
    if (typeof CacheService !== 'undefined') {
      await CacheService.invalidate(['tasks', 'projects', 'users', 'board']);
    }
    return await loadAllData(true);
  }
  window.addEventListener('error', function(e) {
    console.error('Global error caught:', {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      error: e.error
    });
    if (e.message && e.message.includes('import')) {
      console.error('❌ Module import error detected. This may be due to library loading issues.');
    }
  });

  function waitForLibrary(name, timeout = 5000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const check = setInterval(() => {
        if (typeof window[name] !== 'undefined') {
          clearInterval(check);
          resolve(true);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(check);
          console.error(`❌ ${name} failed to load within ${timeout}ms`);
          reject(new Error(`${name} failed to load within ${timeout}ms`));
        }
      }, 100);
    });
  }
  async function loadExternalLibraries() {
    try {
      await waitForLibrary('Chart', 5000);
      await waitForLibrary('Gantt', 5000);
      return true;
    } catch (error) {
      console.error('❌ Library loading failed:', error);
      toast('Failed to load required libraries. Some features may not work. Please refresh the page.', 'error', 5000);
      return false;
    }
  }

  function runDiagnostics() {
    const results = {
      chartJs: typeof Chart !== 'undefined',
      gantt: typeof Gantt !== 'undefined',
      tailwind: typeof tailwind !== 'undefined',
      state: typeof State !== 'undefined',
      taskDetailPanel: typeof TaskDetailPanel !== 'undefined',
      mentionAutocomplete: typeof MentionAutocomplete !== 'undefined',
      timestamp: new Date().toISOString()
    };
    console.table(results);
    if (results.chartJs) {
      try {
        const testCanvas = document.createElement('canvas');
        const testChart = new Chart(testCanvas, {
          type: 'line',
          data: {
            labels: ['Test'],
            datasets: [{
              data: [1]
            }]
          }
        });
        testChart.destroy();
        results.chartJsWorks = true;
      } catch (e) {
        results.chartJsWorks = false;
        results.chartJsError = e.message;
        console.error('❌ Chart.js instantiation test failed:', e.message);
      }
    }
    return results;
  }
  const LoginModal = {
    isVisible: false,
    isLoading: false,
    errorMessage: null,
    show() {
      const modal = $("loginModal");
      if (modal) {
        modal.classList.remove("hidden");
        this.isVisible = true;
        this.clearError();
        const emailInput = $("loginEmail");
        if (emailInput) {
          setTimeout(() => emailInput.focus(), 100);
        }
      }
    },
    hide() {
      const modal = $("loginModal");
      if (modal) {
        modal.classList.add("hidden");
        this.isVisible = false;
        this.clearError();
        this.setLoading(false);
      }
    },
    handleLogin(event) {
      event.preventDefault();
      const emailInput = $("loginEmail");
      const email = emailInput ? emailInput.value.trim() : "";
      if (!this.validateEmail(email)) {
        this.showError("Please enter a valid email address");
        return;
      }
      this.setLoading(true);
      this.clearError();
      google.script.run
        .withSuccessHandler((data) => this.handleLoginSuccess(data))
        .withFailureHandler((error) => this.handleLoginFailure(error))
        .loginWithEmail(email);
    },
    validateEmail(email) {
      if (!email) return false;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    },
    handleLoginSuccess(data) {
      this.setLoading(false);
      this.hide();
      State.user = data.user;
      State.board = data.board;
      State.projects = data.board?.projects || [];
      State.users = data.board?.users || [];
      updateUserDisplay();
      populateFormOptions(data.config);
      renderBoard();
      updateStats();
      updateProjectNav();
      toast("Welcome back, " + (data.user.name || data.user.email) + "!", "success");
    },
    handleLoginFailure(error) {
      console.error("Login failed:", error);
      this.setLoading(false);
      let message = "Login failed. Please try again.";
      if (error && error.message) {
        message = error.message;
      }
      if (message.includes("not found")) {
        message = "User not found. Please contact your administrator for access.";
      } else if (message.includes("invalid")) {
        message = "Please enter a valid email address.";
      }
      this.showError(message);
    },
    showError(message) {
      this.errorMessage = message;
      const errorContainer = $("loginError");
      const errorText = $("loginErrorText");
      if (errorContainer && errorText) {
        errorText.textContent = message;
        errorContainer.classList.remove("hidden");
        errorContainer.classList.add("login-error-shake");
        setTimeout(() => {
          errorContainer.classList.remove("login-error-shake");
        }, 500);
      }
    },
    clearError() {
      this.errorMessage = null;
      const errorContainer = $("loginError");
      if (errorContainer) {
        errorContainer.classList.add("hidden");
      }
    },
    setLoading(loading) {
      this.isLoading = loading;
      const submitBtn = $("loginSubmitBtn");
      const btnText = $("loginBtnText");
      const spinner = $("loginSpinner");
      const emailInput = $("loginEmail");
      if (submitBtn) {
        submitBtn.disabled = loading;
      }
      if (btnText) {
        btnText.textContent = loading ? "Signing in..." : "Sign In";
      }
      if (spinner) {
        spinner.classList.toggle("hidden", !loading);
      }
      if (emailInput) {
        emailInput.disabled = loading;
      }
    }
  };

  function switchView(view) {
    State.view = view;
    State.currentView = view;
    $$(".nav-link[data-view]").forEach((link) => {
      const isActive = link.dataset.view === view;
      link.classList.toggle("active", isActive);
    });
    const boardView = $("boardView");
    const timelineView = $("timelineView");
    const analyticsView = $("analyticsView");
    const funnelView = $("funnelView");
    const listView = $("listView");
    const calendarView = $("calendarView");
    const matrixView = $("matrixView");
    const milestoneView = $("milestoneViewContainer");
    if (boardView) boardView.classList.add("hidden");
    if (timelineView) timelineView.classList.add("hidden");
    if (analyticsView) analyticsView.classList.add("hidden");
    if (funnelView) funnelView.classList.add("hidden");
    if (listView) listView.classList.add("hidden");
    if (calendarView) calendarView.classList.add("hidden");
    if (matrixView) matrixView.classList.add("hidden");
    if (milestoneView) milestoneView.classList.add("hidden");
    const viewTitle = $("viewTitle");
    switch (view) {
      case "timeline":
        if (viewTitle) viewTitle.textContent = "Project Timeline";
        if (timelineView) {
          timelineView.classList.remove("hidden");
          loadTimelineData();
        } else {
          console.error("Timeline view element not found");
          toast("Timeline view not available", "error");
        }
        break;
      case "analytics":
        if (viewTitle) viewTitle.textContent = "Analytics Dashboard";
        if (analyticsView) {
          analyticsView.classList.remove("hidden");
          loadAnalyticsData();
        } else {
          console.error("Analytics view element not found");
          toast("Analytics view not available", "error");
        }
        break;
      case "funnel":
        if (viewTitle) viewTitle.textContent = "Ticket Funnel";
        if (funnelView) {
          funnelView.classList.remove("hidden");
          if (typeof FunnelPage !== 'undefined') {
            FunnelPage.init();
          } else {
            console.error("FunnelPage not loaded");
            toast("Funnel view not available", "error");
          }
        } else {
          console.error("Funnel view element not found");
          toast("Funnel view not available", "error");
        }
        break;
      case "list":
        if (viewTitle) viewTitle.textContent = "List View";
        if (listView) {
          listView.classList.remove("hidden");
          if (typeof ListViewPage !== 'undefined') {
            ListViewPage.init();
          } else {
            console.error("ListViewPage not loaded");
            toast("List view not available", "error");
          }
        } else {
          console.error("List view element not found");
          toast("List view not available", "error");
        }
        break;
      case "calendar":
        if (viewTitle) viewTitle.textContent = "Calendar View";
        if (calendarView) {
          calendarView.classList.remove("hidden");
          if (typeof CalendarViewPage !== 'undefined') {
            CalendarViewPage.init();
          } else {
            console.error("CalendarViewPage not loaded");
            toast("Calendar view not available", "error");
          }
        } else {
          console.error("Calendar view element not found");
          toast("Calendar view not available", "error");
        }
        break;
      case "matrix":
        if (viewTitle) viewTitle.textContent = "Matrix View";
        if (matrixView) {
          matrixView.classList.remove("hidden");
          if (typeof MatrixViewPage !== 'undefined') {
            MatrixViewPage.init();
          } else {
            console.error("MatrixViewPage not loaded");
            toast("Matrix view not available", "error");
          }
        } else {
          console.error("Matrix view element not found");
          toast("Matrix view not available", "error");
        }
        break;
      case "milestones":
        if (viewTitle) viewTitle.textContent = "Milestones Dashboard";
        if (milestoneView) {
          milestoneView.classList.remove("hidden");
          if (typeof MilestonePage !== 'undefined') {
            MilestonePage.init();
          } else {
            console.error("MilestonePage not loaded");
            toast("Milestone view not available", "error");
          }
        } else {
          console.error("Milestone view element not found");
          toast("Milestone view not available", "error");
        }
        break;
      case "master":
        if (viewTitle) viewTitle.textContent = "Master Board";
        if (boardView) boardView.classList.remove("hidden");
        loadBoard();
        break;
      case "my":
      default:
        if (viewTitle) viewTitle.textContent = "My Board";
        if (boardView) boardView.classList.remove("hidden");
        loadBoard();
        break;
    }
  }

  function selectProject(projectId) {
    State.projectFilter = projectId;
    $$(".project-link").forEach((link) => {
      const linkProjectId = link.dataset.project || null;
      link.classList.toggle("active", linkProjectId === projectId);
    });
    switch (State.currentView) {
      case "timeline":
        loadTimelineData();
        break;
      case "analytics":
        loadAnalyticsData();
        break;
      case "list":
        const listProjectFilter = document.getElementById('filterProject');
        if (listProjectFilter) {
          listProjectFilter.value = projectId || '';
        }
        if (typeof ListViewPage !== 'undefined' && ListViewPage.applyFilters) {
          ListViewPage.applyFilters();
        }
        break;
      case "calendar":
        const calProjectFilter = document.getElementById('projectFilter');
        if (calProjectFilter) {
          calProjectFilter.value = projectId || '';
        }
        if (typeof CalendarViewPage !== 'undefined' && CalendarViewPage.filterEvents) {
          CalendarViewPage.filterEvents();
        }
        break;
      case "matrix":
        const matrixProjectFilter = document.getElementById('projectFilterSelect');
        if (matrixProjectFilter) {
          Array.from(matrixProjectFilter.options).forEach(opt => {
            opt.selected = opt.value === projectId;
          });
        }
        if (typeof MatrixViewPage !== 'undefined' && MatrixViewPage.applyFilters) {
          MatrixViewPage.applyFilters();
        }
        break;
      case "milestones":
        const msProjectFilter = document.getElementById('milestoneFilterProject');
        if (msProjectFilter) {
          msProjectFilter.value = projectId || '';
        }
        if (typeof MilestonePage !== 'undefined' && MilestonePage.applyFilters) {
          MilestonePage.applyFilters();
        }
        break;
      case "funnel":
        if (typeof FunnelPage !== 'undefined' && FunnelPage.init) {
          FunnelPage.init();
        }
        break;
      default:
        loadBoard();
        break;
    }
  }
  let lastBoardView = null;
  let lastBoardProjectFilter = null;

  function loadBoard() {
    if (State.currentView === "timeline" || State.currentView === "analytics") {
      return;
    }
    const projectId = State.projectFilter || null;
    const isSameContext = (lastBoardView === State.view && lastBoardProjectFilter === projectId);
    if (State.board && State.board.columns && isSameContext) {
      renderBoard();
      updateStats();
      showLoading(false);
      return;
    }
    if (State.board && State.board.columns) {
      renderBoard();
      updateStats();
    } else {
      showLoading(true);
    }
    lastBoardView = State.view;
    lastBoardProjectFilter = projectId;
    if (State.view === "master") {
      google.script.run
        .withSuccessHandler(handleBoardData)
        .withFailureHandler(handleError)
        .loadMasterBoard(projectId);
    } else {
      google.script.run
        .withSuccessHandler(handleBoardData)
        .withFailureHandler(handleError)
        .loadMyBoard(projectId);
    }
  }

  function handleBoardData(data) {
    State.board = data;
    State.projects = data.projects || State.projects;
    State.users = data.users || State.users;
    if (data && data.columns) {
      const flatTasks = [];
      data.columns.forEach(col => {
        if (col.tasks) {
          col.tasks.forEach(task => {
            flatTasks.push({
              ...task,
              status: col.id
            });
          });
        }
      });
      State.setTasks(flatTasks);
      State.setProjects(data.projects || []);
      State.setUsers(data.users || []);
    }
    renderBoard();
    updateStats();
    updateProjectNav();
    showLoading(false);
  }

  function updateTaskInDOM(taskId, changes) {
    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!card) {
      console.warn(`Task card not found for surgical update: ${taskId}`);
      return false;
    }
    if (changes.status) {
      const targetColumn = document.querySelector(
        `.task-list[data-status="${changes.status}"]`
      );
      if (targetColumn && card.parentElement !== targetColumn) {
        card.remove();
        targetColumn.appendChild(card);
        card.dataset.status = changes.status;
        updateColumnCounts();
      }
    }
    if (changes.title) {
      const titleEl = card.querySelector('.task-title, .font-medium');
      if (titleEl) titleEl.textContent = changes.title;
    }
    if (changes.priority) {
      updatePriorityBadge(card, changes.priority);
    }
    if (changes.assignee) {
      updateAssigneeAvatar(card, changes.assignee);
    }
    if (changes.dueDate !== undefined) {
      const dueDateEl = card.querySelector('.task-due-date, [data-due-date]');
      if (dueDateEl) {
        dueDateEl.textContent = changes.dueDate ? formatDate(changes.dueDate) : '';
        dueDateEl.dataset.dueDate = changes.dueDate || '';
      }
    }
    if (changes.storyPoints !== undefined) {
      const pointsEl = card.querySelector('.story-points');
      if (pointsEl) {
        pointsEl.textContent = changes.storyPoints || '';
        pointsEl.style.display = changes.storyPoints ? '' : 'none';
      }
    }
    if (State.tasks) {
      const task = State.tasks.find(t => t.id === taskId);
      if (task) {
        Object.assign(task, changes);
      }
    }
    if (State.cache?.tasks?.data) {
      const cachedTask = State.cache.tasks.data.find(t => t.id === taskId);
      if (cachedTask) {
        Object.assign(cachedTask, changes);
      }
    }
    return true;
  }

  function updatePriorityBadge(card, priority) {
    const badge = card.querySelector('.priority-badge, [data-priority]');
    if (badge) {
      badge.textContent = priority;
      badge.dataset.priority = priority;
      const colorMap = {
        'Critical': 'bg-red-100 text-red-800',
        'High': 'bg-orange-100 text-orange-800',
        'Medium': 'bg-yellow-100 text-yellow-800',
        'Low': 'bg-green-100 text-green-800'
      };
      badge.className = badge.className
        .split(' ')
        .filter(c => !c.startsWith('bg-') && !c.startsWith('text-'))
        .join(' ');
      const colors = colorMap[priority] || colorMap['Medium'];
      badge.className += ' ' + colors;
    }
  }

  function updateAssigneeAvatar(card, assignee) {
    const avatar = card.querySelector('.assignee-avatar, [data-assignee]');
    if (avatar) {
      avatar.dataset.assignee = assignee;
      const initials = assignee ?
        assignee.split('@')[0].substring(0, 2).toUpperCase() :
        '?';
      avatar.textContent = initials;
      avatar.title = assignee || 'Unassigned';
    }
  }

  function updateColumnCounts() {
    document.querySelectorAll('.board-column').forEach(col => {
      const status = col.dataset.status;
      const taskList = col.querySelector('.task-list');
      const count = taskList ? taskList.querySelectorAll('.task-card').length : 0;
      const countEl = col.querySelector('.task-count, .column-count');
      if (countEl) {
        countEl.textContent = count;
      }
    });
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric'
      });
    } catch (e) {
      return dateStr;
    }
  }

  function removeTaskFromDOM(taskId) {
    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    if (card) {
      card.remove();
      updateColumnCounts();
      if (State.tasks) {
        State.tasks = State.tasks.filter(t => t.id !== taskId);
      }
      if (State.cache?.tasks?.data) {
        State.cache.tasks.data = State.cache.tasks.data.filter(t => t.id !== taskId);
      }
      return true;
    }
    return false;
  }
  async function loadTimelineData() {
    showLoading(true);
    const projectId = State.projectFilter || null;
    try {
      if (State.cache && State.cache.tasks && State.cache.tasks.data && State.cache.tasks.data.length > 0) {
        const tasks = State.cache.tasks.data;
        const timelineTasks = tasks.filter(t => t.dueDate || t.startDate)
          .filter(t => !projectId || t.projectId === projectId)
          .map(t => ({
            id: t.id,
            name: t.title,
            start: t.startDate || t.dueDate,
            end: t.dueDate || t.startDate,
            progress: t.status === 'Done' ? 100 : (t.status === 'In Progress' ? 50 : 0),
            dependencies: '',
            custom_class: t.isMilestone ? 'milestone' : (t.priority === 'Critical' ? 'critical' : 'normal')
          }));
        if (timelineTasks.length > 0) {
          const data = {
            tasks: timelineTasks,
            milestones: tasks.filter(t => t.isMilestone && (!projectId || t.projectId === projectId)),
            dateRange: {
              start: new Date(Math.min(...timelineTasks.map(t => new Date(t.start)))),
              end: new Date(Math.max(...timelineTasks.map(t => new Date(t.end))))
            }
          };
          handleTimelineData(data);
          google.script.run
            .withSuccessHandler((freshData) => {
              if (freshData && freshData.tasks && freshData.tasks.length > 0) {
                State.timelineData = freshData;
                renderTimeline(freshData);
              }
            })
            .withFailureHandler((error) => console.warn("Timeline background refresh failed:", error))
            .getTimelineData(projectId);
          return;
        }
      }
      google.script.run
        .withSuccessHandler(handleTimelineData)
        .withFailureHandler(handleTimelineError)
        .getTimelineData(projectId);
    } catch (error) {
      console.error("Timeline loading error:", error);
      google.script.run
        .withSuccessHandler(handleTimelineData)
        .withFailureHandler(handleTimelineError)
        .getTimelineData(projectId);
    }
  }

  function handleTimelineData(data) {
    if (data) {}
    showLoading(false);
    if (data && data.logs) {}
    if (data && data.error) {
      console.error("Backend Error:", data.error);
    }
    if (!data || !data.tasks || data.tasks.length === 0) {
      console.error("Timeline data is null or has no tasks");
      if (data && data.logs) {
        const logsText = data.logs.join('\n');
        if (logsText.includes('TimelineEngine is not defined')) {
          toast("Timeline engine not loaded. Please redeploy the application.", "error");
        } else if (logsText.includes('Retrieved 0 total tasks')) {
          toast("No tasks found in the system. Create some tasks first.", "warning");
        } else if (logsText.includes('Converted 0 tasks')) {
          toast("No tasks have valid dates. Add start/due dates to tasks to see timeline.", "warning");
        } else if (logsText.includes('serialization')) {
          toast("Data serialization error. Check backend logs in Apps Script.", "error");
        } else if (data.error) {
          toast("Timeline error: " + data.error, "error");
        } else {
          toast("Timeline has no displayable tasks. Check console for details.", "warning");
        }
      } else {
        toast("Timeline data is unavailable. Check console for details.", "error");
      }
      renderEmptyTimeline();
      return;
    }
    State.timelineData = data;
    renderTimeline(data);
  }

  function handleTimelineError(error) {
    console.error("Timeline error:", error);
    showLoading(false);
    toast("Failed to load timeline data", "error");
    renderEmptyTimeline();
  }

  function renderTimeline(data) {
    const ganttContainer = $("ganttContainer");
    const timelineList = $("timelineList");
    if (!data.tasks || data.tasks.length === 0) {
      renderEmptyTimeline();
      return;
    }
    if (ganttContainer && typeof Gantt !== "undefined") {
      try {
        ganttContainer.innerHTML = "";
        const criticalPath = data.criticalPath || [];
        const dependencies = data.dependencies || [];
        const dependencyMap = new Map();
        dependencies.forEach(dep => {
          if (!dependencyMap.has(dep.to)) {
            dependencyMap.set(dep.to, []);
          }
          dependencyMap.get(dep.to).push(dep.from);
        });
        const ganttTasks = data.tasks.map((task) => {
          const isCritical = criticalPath.includes(task.id);
          const taskDeps = dependencyMap.get(task.id) || [];
          const dependencyString = taskDeps.join(',');
          const startDate = typeof task.start === 'string' ? new Date(task.start) : task.start;
          const endDate = typeof task.end === 'string' ? new Date(task.end) : task.end;
          return {
            id: task.id,
            name: task.name || task.title,
            start: formatDateForGantt(startDate),
            end: formatDateForGantt(endDate),
            progress: task.progress || 0,
            dependencies: dependencyString,
            custom_class: getTaskClass(task, isCritical),
          };
        });
        new Gantt(ganttContainer, ganttTasks, {
          view_mode: "Week",
          date_format: "YYYY-MM-DD",
          arrow_curve: 5,
          padding: 18,
          view_modes: ['Day', 'Week', 'Month'],
          bar_height: 30,
          bar_corner_radius: 3,
          popup_trigger: 'click',
          on_click: (task) => openTaskDetailPanel(task.id),
          on_date_change: (task, start, end) =>
            updateTaskDates(task.id, start, end),
        });
        setTimeout(() => {
          styleGanttDependencyArrows(criticalPath, dependencies);
        }, 100);
      } catch (e) {
        console.error("Gantt render error:", e);
        ganttContainer.innerHTML =
          '<div class="p-4 text-center text-gray-500">Unable to render Gantt chart</div>';
      }
    }
    if (timelineList) {
      renderTimelineList(data.tasks);
    }
  }

  function styleGanttDependencyArrows(criticalPath, dependencies) {
    if (!criticalPath || criticalPath.length === 0) return;
    try {
      const arrowElements = document.querySelectorAll('.arrow');
      arrowElements.forEach(arrow => {
        const arrowPath = arrow.querySelector('path');
        if (arrowPath) {
          const nearCriticalTask = criticalPath.some(taskId => {
            const taskBar = document.querySelector(`.bar-wrapper[data-id="${taskId}"]`);
            if (taskBar) {
              const barRect = taskBar.getBoundingClientRect();
              const arrowRect = arrow.getBoundingClientRect();
              const overlaps = !(barRect.right < arrowRect.left ||
                barRect.left > arrowRect.right ||
                barRect.bottom < arrowRect.top ||
                barRect.top > arrowRect.bottom);
              return overlaps;
            }
            return false;
          });
          if (nearCriticalTask) {
            arrowPath.setAttribute('stroke', '#dc2626');
            arrowPath.setAttribute('stroke-width', '2');
            arrowPath.setAttribute('marker-end', 'url(#arrowhead-critical)');
          } else {
            arrowPath.setAttribute('stroke', '#94a3b8');
            arrowPath.setAttribute('stroke-width', '1.5');
          }
        }
      });
      const svg = document.querySelector('.gantt-container svg');
      if (svg) {
        const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        if (!svg.querySelector('defs')) {
          svg.insertBefore(defs, svg.firstChild);
        }
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        marker.setAttribute('id', 'arrowhead-critical');
        marker.setAttribute('markerWidth', '10');
        marker.setAttribute('markerHeight', '10');
        marker.setAttribute('refX', '9');
        marker.setAttribute('refY', '3');
        marker.setAttribute('orient', 'auto');
        const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        polygon.setAttribute('points', '0 0, 10 3, 0 6');
        polygon.setAttribute('fill', '#dc2626');
        marker.appendChild(polygon);
        defs.appendChild(marker);
      }
    } catch (error) {
      console.error('Error styling Gantt arrows:', error);
    }
  }

  function renderEmptyTimeline() {
    const ganttContainer = $("ganttContainer");
    const timelineList = $("timelineList");
    const emptyMessage = `
    <div class="p-8 text-center text-gray-500">
    <i class="fas fa-calendar-alt text-4xl mb-4"></i>
    <p>No tasks with dates found for timeline view</p>
    <p class="text-sm mt-2">Add start and due dates to your tasks to see them here</p>
    </div>
    `;
    if (ganttContainer) ganttContainer.innerHTML = emptyMessage;
    if (timelineList) timelineList.innerHTML = emptyMessage;
  }

  function renderTimelineList(tasks) {
    const container = $("timelineList");
    if (!container) return;
    if (!tasks || tasks.length === 0) {
      container.innerHTML =
        '<div class="p-4 text-center text-gray-500">No tasks to display</div>';
      return;
    }
    container.innerHTML = tasks
      .map(
        (task) => `
  <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="openTaskModal('${
    task.id
  }')">
  <div class="flex items-center justify-between">
  <div class="flex items-center gap-3">
  <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(
    task.status
    )}">
  ${escapeHtml(task.status)}
  </span>
  <span class="font-medium text-gray-900">${escapeHtml(
    task.name || task.title
    )}</span>
  </div>
  <div class="text-sm text-gray-500">
  ${task.start ? formatDate(task.start) : "No start"} - ${
    task.end ? formatDate(task.end) : "No end"
  }
  </div>
  </div>
  ${
    task.assignee
    ? `<div class="text-sm text-gray-500 mt-1">Assigned to: ${escapeHtml(
      task.assignee
      )}</div>`
    : ""
  }
  </div>
  `
      )
      .join("");
  }

  function formatDateForGantt(date) {
    if (!date) return null;
    const d = new Date(date);
    return d.toISOString().split("T")[0];
  }

  function getTaskClass(task, isCritical = false) {
    const classes = ["task-" + (task.priority || "medium").toLowerCase()];
    if (task.status === "Done") classes.push("task-completed");
    if (task.isOverdue) classes.push("task-overdue");
    if (isCritical) classes.push("task-critical");
    return classes.join(" ");
  }

  function updateTaskDates(taskId, start, end) {
    google.script.run
      .withSuccessHandler(() => {
        toast("Task dates updated", "success");
      })
      .withFailureHandler(handleError)
      .saveTaskUpdate(taskId, {
        startDate: start.toISOString(),
        dueDate: end.toISOString(),
      });
  }

  function initializeTimelineFilters() {
    const statusFilter = $("timelineStatusFilter");
    const priorityFilter = $("timelinePriorityFilter");
    if (statusFilter && State.board?.config?.statuses) {
      statusFilter.innerHTML =
        '<option value="">All Statuses</option>' +
        State.board.config.statuses
        .map((s) => `<option value="${s}">${s}</option>`)
        .join("");
    }
    if (priorityFilter && State.board?.config?.priorities) {
      priorityFilter.innerHTML =
        '<option value="">All Priorities</option>' +
        State.board.config.priorities
        .map((p) => `<option value="${p}">${p}</option>`)
        .join("");
    }
  }

  function applyTimelineFilters() {
    const filters = {
      status: $("timelineStatusFilter")?.value ?
        [$("timelineStatusFilter").value] :
        [],
      priority: $("timelinePriorityFilter")?.value ?
        [$("timelinePriorityFilter").value] :
        [],
      search: $("timelineSearch")?.value || "",
    };
    showLoading(true);
    google.script.run
      .withSuccessHandler(handleTimelineData)
      .withFailureHandler(handleTimelineError)
      .getFilteredTimeline(State.projectFilter, filters);
  }

  function clearTimelineFilters() {
    if ($("timelineStatusFilter")) $("timelineStatusFilter").value = "";
    if ($("timelinePriorityFilter")) $("timelinePriorityFilter").value = "";
    if ($("timelineSearch")) $("timelineSearch").value = "";
    loadTimelineData();
  }
  let lastAnalyticsDateRange = null;

  function loadAnalyticsData() {
    const dateRange = $("analyticsDateRange")?.value || "30";
    const isSameContext = (lastAnalyticsDateRange === dateRange);
    if (State.analyticsData && isSameContext) {
      handleAnalyticsData(State.analyticsData);
      return;
    }
    if (State.analyticsData) {
      handleAnalyticsData(State.analyticsData);
    } else {
      showLoading(true);
    }
    lastAnalyticsDateRange = dateRange;
    google.script.run
      .withSuccessHandler(handleAnalyticsData)
      .withFailureHandler(handleAnalyticsError)
      .getAnalyticsData(parseInt(dateRange));
  }

  function handleAnalyticsData(data) {
    showLoading(false);
    if (!data) {
      toast("No analytics data available", "warning");
      return;
    }
    State.analyticsData = data;
    updateAnalyticsMetrics(data.metrics);
    updateCompletionChart(data.completionTrend);
    updatePriorityChart(data.priorityDistribution);
    updateTeamProductivity(data.teamProductivity);
    updateProjectHealth(data.projectHealth);
    updateRecentActivity(data.recentActivity);
  }

  function handleAnalyticsError(error) {
    console.error("Analytics error:", error);
    showLoading(false);
    toast("Failed to load analytics data", "error");
  }

  function updateAnalyticsMetrics(metrics) {
    if (!metrics) return;
    const elements = {
      analyticsStatTotal: metrics.total,
      analyticsStatCompleted: metrics.completed,
      analyticsStatInProgress: metrics.inProgress,
      analyticsStatOverdue: metrics.overdue,
      totalTasks: metrics.total,
      completedTasks: metrics.completed,
      inProgressTasks: metrics.inProgress,
      overdueTasks: metrics.overdue,
    };
    Object.entries(elements).forEach(([id, value]) => {
      const el = $(id);
      if (el) el.textContent = value || 0;
    });
  }

  function updateCompletionChart(data) {
    const canvas = $("completionTrendCanvas");
    if (!canvas || !data) {
      console.warn('Canvas or data not available for completion chart');
      return;
    }
    if (!window.Chart) {
      console.warn('Chart.js not available');
      if (canvas && canvas.parentElement) {
        canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-chart-line text-4xl mb-2 text-gray-300"></i><p>Chart library unavailable</p></div></div>';
      }
      return;
    }
    try {
      if (window.completionTrendChart) {
        window.completionTrendChart.destroy();
      }
      const ctx = canvas.getContext("2d");
      window.completionTrendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map((item) => item.date),
          datasets: [{
            label: "Tasks Completed",
            data: data.map((item) => item.completed || 0),
            borderColor: "#f59e0b",
            backgroundColor: "rgba(245, 158, 11, 0.1)",
            fill: true,
            tension: 0.3,
          }, ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
          },
          scales: {
            y: {
              beginAtZero: true
            },
          },
        },
      });
    } catch (error) {
      console.error('❌ Failed to render completion chart:', error);
      if (canvas && canvas.parentElement) {
        canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-red-500"><div class="text-center"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p>Chart failed to render</p></div></div>';
      }
    }
  }

  function updatePriorityChart(data) {
    const canvas = $("priorityChartCanvas");
    if (!canvas || !data) {
      console.warn('Canvas or data not available for priority chart');
      return;
    }
    if (!window.Chart) {
      console.warn('Chart.js not available');
      if (canvas && canvas.parentElement) {
        canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-chart-pie text-4xl mb-2 text-gray-300"></i><p>Chart library unavailable</p></div></div>';
      }
      return;
    }
    try {
      if (window.priorityChart) {
        window.priorityChart.destroy();
      }
      const colors = {
        Critical: "#dc2626",
        High: "#f97316",
        Medium: "#eab308",
        Low: "#22c55e",
      };
      const ctx = canvas.getContext("2d");
      window.priorityChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: data.map((item) => item.priority),
          datasets: [{
            data: data.map((item) => item.count),
            backgroundColor: data.map(
              (item) => colors[item.priority] || "#6b7280"
            ),
          }, ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom"
            },
          },
        },
      });
    } catch (error) {
      console.error('❌ Failed to render priority chart:', error);
      if (canvas && canvas.parentElement) {
        canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-red-500"><div class="text-center"><i class="fas fa-exclamation-triangle text-4xl mb-2"></i><p>Chart failed to render</p></div></div>';
      }
    }
  }

  function updateTeamProductivity(data) {
    const container = $("teamProductivityList");
    if (!container || !data) return;
    if (data.length === 0) {
      container.innerHTML =
        '<div class="p-4 text-center text-gray-500">No team data available</div>';
      return;
    }
    container.innerHTML = data
      .slice(0, 10)
      .map(
        (member) => `
  <div class="flex items-center justify-between p-3 hover:bg-gray-50">
  <div class="flex items-center gap-3">
  <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white text-sm font-medium">
  ${getInitials(member.name)}
  </div>
  <div>
  <div class="font-medium text-gray-900">${escapeHtml(
    member.name
    )}</div>
  <div class="text-xs text-gray-500">${member.tasksCompleted}/${
    member.totalTasks
  } completed</div>
  </div>
  </div>
  <div class="flex items-center gap-2">
  <div class="w-24 bg-gray-200 rounded-full h-2">
  <div class="bg-primary-500 h-2 rounded-full" style="width: ${
    member.productivity
  }%"></div>
  </div>
  <span class="text-sm font-medium text-gray-600">${
    member.productivity
  }%</span>
  </div>
  </div>
  `
      )
      .join("");
  }

  function updateProjectHealth(data) {
    const container = $("projectHealthList");
    if (!container || !data) return;
    if (data.length === 0) {
      container.innerHTML =
        '<div class="p-4 text-center text-gray-500">No projects found</div>';
      return;
    }
    const healthColors = {
      excellent: "bg-green-100 text-green-800",
      good: "bg-blue-100 text-blue-800",
      "at-risk": "bg-yellow-100 text-yellow-800",
      poor: "bg-red-100 text-red-800",
    };
    container.innerHTML = data
      .map(
        (project) => `
  <div class="p-4 border-b border-gray-100 last:border-0">
  <div class="flex items-center justify-between mb-2">
  <span class="font-medium text-gray-900">${escapeHtml(
    project.name
    )}</span>
  <span class="px-2 py-1 rounded text-xs font-medium ${
    healthColors[project.health] || "bg-gray-100"
  }">${project.health}</span>
  </div>
  <div class="flex items-center gap-2">
  <div class="flex-1 bg-gray-200 rounded-full h-2">
  <div class="bg-primary-500 h-2 rounded-full" style="width: ${
    project.progress
  }%"></div>
  </div>
  <span class="text-sm text-gray-500">${project.progress}%</span>
  </div>
  <div class="text-xs text-gray-500 mt-1">${project.tasksCompleted}/${
    project.totalTasks
  } tasks completed</div>
  </div>
  `
      )
      .join("");
  }

  function updateRecentActivity(data) {
    const container = $("recentActivity") || $("recentActivityList");
    if (!container || !data) return;
    if (data.length === 0) {
      container.innerHTML =
        '<div class="p-4 text-center text-gray-500">No recent activity</div>';
      return;
    }
    container.innerHTML = data
      .slice(0, 10)
      .map(
        (activity) => `
  <div class="flex items-start gap-3 p-3 hover:bg-gray-50">
  <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm">
  <i class="fas ${getActivityIcon(activity.type)}"></i>
  </div>
  <div class="flex-1">
  <div class="text-sm text-gray-900">${escapeHtml(
    activity.description
    )}</div>
  <div class="text-xs text-gray-500">${escapeHtml(
    activity.user
    )} • ${formatRelativeTime(activity.timestamp)}</div>
  </div>
  </div>
  `
      )
      .join("");
  }

  function getActivityIcon(type) {
    const icons = {
      created: "fa-plus",
      updated: "fa-edit",
      moved: "fa-arrows-alt",
      completed: "fa-check",
      comment: "fa-comment",
      assigned: "fa-user-plus",
    };
    return icons[type] || "fa-circle";
  }

  function refreshAnalytics() {
    loadAnalyticsData();
  }

  function renderBoard() {
    const board = $("board");
    if (!board || !State.board || !State.board.columns) return;
    let html = "";
    State.board.columns.forEach((col) => {
      html += `<div class="board-column" data-status="${col.id}">`;
      html += `<div class="column-header" style="border-top-color: ${col.color}">`;
      html += `<h3 class="text-sm font-semibold text-gray-700">${escapeHtml(
        col.name
        )}</h3>`;
      html += `<span class="text-xs font-medium bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">${col.count}</span>`;
      html += `</div>`;
      html += `<div class="task-list" data-status="${col.id}">`;
      col.tasks.forEach((task) => {
        html += renderTaskCard(task, col.id);
      });
      html += `</div></div>`;
    });
    board.innerHTML = html;
    initDragAndDrop();
  }

  function renderTaskCard(task, columnId) {
    const priorityColors = {
      Critical: "bg-red-100 text-red-700 border-red-200",
      High: "bg-orange-100 text-orange-700 border-orange-200",
      Medium: "bg-yellow-100 text-yellow-700 border-yellow-200",
      Low: "bg-green-100 text-green-700 border-green-200",
    };
    const priorityClass =
      priorityColors[task.priority] || "bg-gray-100 text-gray-700";
    const isMilestone = task.isMilestone === true || task.isMilestone === 'true';
    let milestoneClass = '';
    let milestoneState = '';
    if (isMilestone) {
      milestoneClass = 'milestone';
      if (task.status === 'Done') {
        milestoneState = 'completed';
      } else if (task.milestoneDate) {
        const now = new Date();
        const milestoneDate = new Date(task.milestoneDate);
        const daysUntil = Math.ceil((milestoneDate - now) / (1000 * 60 * 60 * 24));
        if (milestoneDate < now) {
          milestoneState = 'overdue';
        } else if (daysUntil <= 7) {
          milestoneState = 'upcoming';
        }
      }
    }
    const hasDependencies = task.hasDependencies === true;
    const isBlocked = task.isBlocked === true;
    const blockedByCount = task.blockedByCount || 0;
    const blockingCount = task.blockingCount || 0;
    let dependencyTooltip = '';
    if (hasDependencies) {
      const parts = [];
      if (blockedByCount > 0) {
        parts.push(`🔒 Blocked by ${blockedByCount} task${blockedByCount > 1 ? 's' : ''}`);
      }
      if (blockingCount > 0) {
        parts.push(`⏳ Blocking ${blockingCount} task${blockingCount > 1 ? 's' : ''}`);
      }
      dependencyTooltip = parts.join(' • ');
    }
    let blockedClass = '';
    let cardBorderStyle = '';
    if (isBlocked) {
      blockedClass = 'task-blocked';
      cardBorderStyle = 'border-red-400 border-2';
    }
    return `
  <div class="task-card ${milestoneClass} ${milestoneState} ${blockedClass} bg-white rounded-lg p-3 shadow-sm border ${cardBorderStyle || 'border-gray-200'} cursor-pointer hover:shadow-md transition-shadow"
  draggable="true"
  data-task-id="${task.id}"
  data-status="${columnId || ''}"
  onclick="openTaskDetailPanel('${task.id}')"
  ${dependencyTooltip ? `title="${escapeHtml(dependencyTooltip)}"` : ''}>
  <div class="flex items-start justify-between mb-2">
  <div class="flex items-center gap-1">
  <span class="text-xs font-mono text-gray-500">${escapeHtml(task.id)}</span>
  ${hasDependencies ? '<i class="fas fa-link text-blue-500 text-xs" title="Has dependencies"></i>' : ''}
  ${isBlocked ? '<span class="ml-1 px-1 py-0.5 text-xs bg-red-100 text-red-700 rounded font-semibold" title="Blocked by incomplete tasks">🔒 BLOCKED</span>' : ''}
  </div>
  <span class="px-1.5 py-0.5 text-xs rounded ${priorityClass}">${escapeHtml(
    task.priority
    )}</span>
  </div>
  <h4 class="task-title text-sm font-medium text-gray-900 mb-2 ${isBlocked ? 'opacity-70' : ''}">${escapeHtml(
    task.title
    )}</h4>
  ${
    isMilestone && task.milestoneDate
    ? `<div class="text-xs text-gray-600 mb-2">
    <i class="fas fa-flag-checkered mr-1"></i>
    ${formatDate(task.milestoneDate)}
    ${task.milestoneType ? `<span class="ml-1 opacity-75">(${task.milestoneType.replace(/-/g, ' ')})</span>` : ''}
    </div>`
    : task.dueDate
    ? `<div class="text-xs text-gray-500 mb-2"><i class="far fa-calendar mr-1"></i>${formatDate(
      task.dueDate
      )}</div>`
    : ""
  }
  ${
    isMilestone
    ? `<div class="milestone-badge">
    <i class="fas fa-flag"></i>
    MILESTONE
    </div>`
    : ""
  }
  ${
    isBlocked && task.dependencyMetadata && task.dependencyMetadata.blockedByTasks && task.dependencyMetadata.blockedByTasks.length > 0
    ? `<div class="text-xs text-red-600 mb-2 p-2 bg-red-50 rounded border border-red-200">
    <div class="font-semibold mb-1">Blocked by:</div>
    ${task.dependencyMetadata.blockedByTasks.map(bt =>
      `<div class="truncate" title="${escapeHtml(bt.title)}">• ${escapeHtml(bt.id)}: ${escapeHtml(bt.title.substring(0, 30))}${bt.title.length > 30 ? '...' : ''}</div>`
      ).join('')}
    </div>`
    : ""
  }
  <div class="flex items-center justify-between ${isMilestone ? 'mt-2' : ''}">
  ${
    task.assignee
    ? `<div class="w-6 h-6 rounded-full bg-primary-500 text-white text-xs flex items-center justify-center" title="${escapeHtml(
      task.assignee
      )}">${getInitials(task.assignee)}</div>`
    : "<div></div>"
  }
  <div class="flex items-center gap-1">
  ${
    !isMilestone && task.type
    ? `<span class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded">${escapeHtml(
      task.type
      )}</span>`
    : ""
  }
  </div>
  </div>
  </div>
  `;
  }

  function openTaskDetailPanel(taskId) {
    try {
      if (!taskId || typeof taskId !== 'string' || taskId.trim() === '') {
        console.error('openTaskDetailPanel: Invalid taskId', taskId);
        toast('Invalid task ID', 'error');
        return;
      }
      const cleanTaskId = taskId.trim();
      const cachedTask = findTaskInCache(cleanTaskId);
      showSimpleTaskModal(cleanTaskId, cachedTask);
    } catch (error) {
      console.error('openTaskDetailPanel error:', error);
      toast('Failed to open task: ' + (error.message || 'Unknown error'), 'error');
    }
  }

  function findTaskInCache(taskId) {
    if (State.board && State.board.columns) {
      for (const col of State.board.columns) {
        if (col.tasks) {
          const task = col.tasks.find(t => t.id === taskId);
          if (task) return task;
        }
      }
    }
    return null;
  }

  function showSimpleTaskModal(taskId, cachedTask) {
    const existing = document.getElementById('simpleTaskModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = 'simpleTaskModal';
    modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.15s ease-out;
    `;
    modal.onclick = (e) => {
      if (e.target === modal) closeSimpleTaskModal();
    };
    if (!document.getElementById('modalAnimations')) {
      const style = document.createElement('style');
      style.id = 'modalAnimations';
      style.textContent = `
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    `;
      document.head.appendChild(style);
    }
    const content = document.createElement('div');
    content.style.cssText = `
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 640px;
  max-height: 85vh;
  overflow: auto;
  box-shadow: 0 25px 50px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.05);
  animation: slideUp 0.2s ease-out;
  `;
    if (cachedTask) {
      content.innerHTML = renderTaskModalContent(cachedTask);
      modal.appendChild(content);
      document.body.appendChild(modal);
      setTimeout(() => loadModalDependencies(taskId), 50);
    } else {
      content.innerHTML = `
    <div style="padding: 60px 40px; text-align: center; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
    <div style="width: 48px; height: 48px; border: 3px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
    <div style="color: #64748b; font-size: 14px; font-weight: 500;">Loading task details...</div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>
    `;
      modal.appendChild(content);
      document.body.appendChild(modal);
      google.script.run
        .withSuccessHandler((task) => {
          if (task) {
            content.innerHTML = renderTaskModalContent(task);
            setTimeout(() => loadModalDependencies(taskId), 50);
          } else {
            content.innerHTML = `
        <div style="padding: 60px 40px; text-align: center;">
        <div style="width: 64px; height: 64px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
        <svg width="32" height="32" fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
        </div>
        <div style="color: #dc2626; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Task Not Found</div>
        <div style="color: #6b7280; font-size: 13px; margin-bottom: 20px;">The task may have been deleted or you don't have access.</div>
        <button onclick="closeSimpleTaskModal()" style="padding: 10px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Close</button>
        </div>
        `;
          }
        })
        .withFailureHandler((error) => {
          content.innerHTML = `
    <div style="padding: 60px 40px; text-align: center;">
    <div style="width: 64px; height: 64px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
    <svg width="32" height="32" fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4M12 16h.01"/><circle cx="12" cy="12" r="10"/></svg>
    </div>
    <div style="color: #dc2626; font-size: 16px; font-weight: 600; margin-bottom: 8px;">Failed to Load Task</div>
    <div style="color: #6b7280; font-size: 13px; margin-bottom: 20px;">Please check your connection and try again.</div>
    <button onclick="closeSimpleTaskModal()" style="padding: 10px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Close</button>
    </div>
    `;
        })
        .loadTask(taskId);
    }
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        closeSimpleTaskModal();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
  }

  function renderTaskModalContent(task) {
    const priorityConfig = {
      'Critical': {
        bg: '#fef2f2',
        color: '#dc2626',
        icon: '🔴'
      },
      'Highest': {
        bg: '#fff7ed',
        color: '#ea580c',
        icon: '🟠'
      },
      'High': {
        bg: '#fffbeb',
        color: '#d97706',
        icon: '🟡'
      },
      'Medium': {
        bg: '#eff6ff',
        color: '#2563eb',
        icon: '🔵'
      },
      'Low': {
        bg: '#f0fdf4',
        color: '#16a34a',
        icon: '🟢'
      },
      'Lowest': {
        bg: '#f9fafb',
        color: '#6b7280',
        icon: '⚪'
      }
    };
    const statusConfig = {
      'Backlog': {
        bg: '#f3f4f6',
        color: '#6b7280'
      },
      'To Do': {
        bg: '#dbeafe',
        color: '#1d4ed8'
      },
      'In Progress': {
        bg: '#fef3c7',
        color: '#b45309'
      },
      'Review': {
        bg: '#f3e8ff',
        color: '#7c3aed'
      },
      'Testing': {
        bg: '#cffafe',
        color: '#0891b2'
      },
      'Done': {
        bg: '#dcfce7',
        color: '#15803d'
      }
    };
    const typeConfig = {
      'Epic': {
        icon: '⚡',
        color: '#7c3aed'
      },
      'Story': {
        icon: '📖',
        color: '#2563eb'
      },
      'Task': {
        icon: '✅',
        color: '#16a34a'
      },
      'Bug': {
        icon: '🐛',
        color: '#dc2626'
      },
      'Subtask': {
        icon: '📎',
        color: '#6b7280'
      }
    };
    const priority = priorityConfig[task.priority] || priorityConfig['Medium'];
    const status = statusConfig[task.status] || statusConfig['To Do'];
    const type = typeConfig[task.type] || typeConfig['Task'];
    return `
  <!-- Header with gradient -->
  <div style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 20px 24px; border-radius: 12px 12px 0 0;">
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
  <div style="flex: 1;">
  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
  <span style="font-size: 11px; font-family: 'SF Mono', monospace; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px;">${escapeHtml(task.id)}</span>
  <span style="font-size: 11px; padding: 3px 10px; border-radius: 12px; background: ${priority.bg}; color: ${priority.color}; font-weight: 600;">${priority.icon} ${escapeHtml(task.priority)}</span>
  ${task.isMilestone ? '<span style="font-size: 11px; padding: 3px 10px; border-radius: 12px; background: #fef3c7; color: #92400e; font-weight: 600;">🏁 Milestone</span>' : ''}
  </div>
  <h2 style="font-size: 18px; font-weight: 600; color: white; margin: 0; line-height: 1.4;">${escapeHtml(task.title)}</h2>
  </div>
  <button onclick="closeSimpleTaskModal()" style="background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: rgba(255,255,255,0.7); font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">×</button>
  </div>
  </div>
  <div style="padding: 20px 24px;">
  <!-- Status & Type Row -->
  <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
  <div style="display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: ${status.bg}; border-radius: 8px;">
  <div style="width: 8px; height: 8px; border-radius: 50%; background: ${status.color};"></div>
  <span style="font-size: 13px; font-weight: 600; color: ${status.color};">${escapeHtml(task.status)}</span>
  </div>
  <div style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
  <span style="font-size: 14px;">${type.icon}</span>
  <span style="font-size: 13px; font-weight: 500; color: ${type.color};">${escapeHtml(task.type || 'Task')}</span>
  </div>
  </div>
  <!-- Details Grid -->
  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
  <div style="background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0;">
  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
  <svg width="14" height="14" fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
  <span style="font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px;">Assignee</span>
  </div>
  <div style="font-size: 14px; font-weight: 500; color: #1e293b;">${escapeHtml(task.assignee || 'Unassigned')}</div>
  </div>
  <div style="background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0;">
  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
  <svg width="14" height="14" fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
  <span style="font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px;">Due Date</span>
  </div>
  <div style="font-size: 14px; font-weight: 500; color: ${task.dueDate && new Date(task.dueDate) < new Date() ? '#dc2626' : '#1e293b'};">${task.dueDate ? formatDate(task.dueDate) : 'No due date'}</div>
  </div>
  ${task.projectName ? `
    <div style="background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0;">
    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
    <svg width="14" height="14" fill="none" stroke="#6b7280" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2v11z"/></svg>
    <span style="font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px;">Project</span>
    </div>
    <div style="font-size: 14px; font-weight: 500; color: #1e293b;">${escapeHtml(task.projectName)}</div>
    </div>
    ` : ''}
  ${task.storyPoints ? `
    <div style="background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0;">
    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
    <span style="font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px;">Story Points</span>
    </div>
    <div style="font-size: 14px; font-weight: 500; color: #1e293b;">${task.storyPoints}</div>
    </div>
    ` : ''}
  </div>
  <!-- Description -->
  ${task.description ? `
    <div style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
    <svg width="16" height="16" fill="none" stroke="#374151" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10"/></svg>
    <span style="font-size: 12px; text-transform: uppercase; color: #374151; font-weight: 600; letter-spacing: 0.5px;">Description</span>
    </div>
    <div style="font-size: 14px; color: #475569; line-height: 1.7; white-space: pre-wrap; background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #e2e8f0;">${escapeHtml(task.description)}</div>
    </div>
    ` : ''}
  <!-- Dependencies Section -->
  <div id="taskModalDependencies" style="margin-bottom: 20px;">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
  <div style="display: flex; align-items: center; gap: 6px;">
  <svg width="16" height="16" fill="none" stroke="#374151" stroke-width="2" viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
  <span style="font-size: 12px; text-transform: uppercase; color: #374151; font-weight: 600; letter-spacing: 0.5px;">Dependencies</span>
  </div>
  <button onclick="openDependencyPickerFromModal('${task.id}', 'predecessor')" style="font-size: 12px; padding: 6px 12px; background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='#eff6ff'">
  <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
  Add Blocker
  </button>
  </div>
  <div id="dependenciesLoading" style="padding: 20px; text-align: center; color: #6b7280; font-size: 13px;">
  Loading dependencies...
  </div>
  <div id="dependenciesList" style="display: none;"></div>
  </div>
  <!-- Action Buttons -->
  <div style="display: flex; gap: 10px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
  <button onclick="openEditFromSimpleModal('${task.id}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 4px rgba(245,158,11,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(245,158,11,0.4)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 4px rgba(245,158,11,0.3)'">
  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
  Edit Task
  </button>
  <button onclick="closeSimpleTaskModal()" style="flex: 1; padding: 12px; background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
  Close
  </button>
  </div>
  </div>
  `;
  }

  function loadModalDependencies(taskId) {
    const loadingEl = document.getElementById('dependenciesLoading');
    const listEl = document.getElementById('dependenciesList');
    if (!loadingEl || !listEl) return;
    google.script.run
      .withSuccessHandler((deps) => {
        loadingEl.style.display = 'none';
        listEl.style.display = 'block';
        listEl.innerHTML = renderDependenciesList(deps, taskId);
      })
      .withFailureHandler((error) => {
        loadingEl.innerHTML = '<span style="color: #dc2626;">Failed to load dependencies</span>';
      })
      .getTaskDependenciesWithDetails(taskId);
  }

  function renderDependenciesList(deps, taskId) {
    const predecessors = deps.predecessors || [];
    const successors = deps.successors || [];
    if (predecessors.length === 0 && successors.length === 0) {
      return `
      <div style="padding: 16px; text-align: center; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
      <div style="color: #64748b; font-size: 13px;">No dependencies configured</div>
      <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">Click "Add Blocker" to create dependencies</div>
      </div>
      `;
    }
    let html = '';
    if (predecessors.length > 0) {
      html += `
    <div style="margin-bottom: 12px;">
    <div style="font-size: 11px; text-transform: uppercase; color: #dc2626; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4M12 16h.01"/><circle cx="12" cy="12" r="10"/></svg>
    Blocked By (${predecessors.length})
    </div>
    ${predecessors.map(dep => dep.task ? `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin-bottom: 6px;">
      <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;">
      <span style="font-size: 11px; font-family: monospace; color: #991b1b; background: #fee2e2; padding: 2px 6px; border-radius: 4px;">${escapeHtml(dep.task.id)}</span>
      <span style="font-size: 13px; color: #7f1d1d; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(dep.task.title)}</span>
      <span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: white; color: #6b7280;">${escapeHtml(dep.task.status)}</span>
      </div>
      <button onclick="removeDependency('${dep.id}', '${taskId}')" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 4px;" title="Remove dependency">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
      </div>
      ` : '').join('')}
    </div>
    `;
    }
    if (successors.length > 0) {
      html += `
    <div>
    <div style="font-size: 11px; text-transform: uppercase; color: #2563eb; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    Blocking (${successors.length})
    </div>
    ${successors.map(dep => dep.task ? `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; margin-bottom: 6px;">
      <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;">
      <span style="font-size: 11px; font-family: monospace; color: #1e40af; background: #dbeafe; padding: 2px 6px; border-radius: 4px;">${escapeHtml(dep.task.id)}</span>
      <span style="font-size: 13px; color: #1e3a8a; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(dep.task.title)}</span>
      <span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: white; color: #6b7280;">${escapeHtml(dep.task.status)}</span>
      </div>
      <button onclick="removeDependency('${dep.id}', '${taskId}')" style="background: none; border: none; color: #2563eb; cursor: pointer; padding: 4px;" title="Remove dependency">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
      </div>
      ` : '').join('')}
    </div>
    `;
    }
    return html;
  }

  function openDependencyPickerFromModal(taskId, type) {
    if (typeof DependencyPicker !== 'undefined') {
      DependencyPicker.open(taskId, type);
    } else {
      toast('Dependency picker not available', 'error');
    }
  }

  function removeDependency(dependencyId, taskId) {
    if (!confirm('Remove this dependency?')) return;
    google.script.run
      .withSuccessHandler((result) => {
        if (result.success) {
          toast('Dependency removed', 'success');
          loadModalDependencies(taskId);
        } else {
          toast(result.error || 'Failed to remove dependency', 'error');
        }
      })
      .withFailureHandler((error) => {
        toast('Failed to remove dependency', 'error');
      })
      .removeDependency(dependencyId);
  }

  function closeSimpleTaskModal() {
    const modal = document.getElementById('simpleTaskModal');
    if (modal) modal.remove();
  }

  function openEditFromSimpleModal(taskId) {
    closeSimpleTaskModal();
    if (typeof TaskEditModal !== 'undefined') {
      TaskEditModal.open(taskId);
    } else {
      toast('Edit modal not available', 'error');
    }
  }

  function updateStats() {
    if (!State.board || !State.board.stats) return;
    const stats = State.board.stats;
    const elements = {
      statTotal: stats.total,
      statCompleted: stats.completed,
      statProgress: stats.progress + "%",
      statDueSoon: stats.dueSoon,
      statOverdue: stats.overdue,
    };
    Object.entries(elements).forEach(([id, value]) => {
      const el = $(id);
      if (el) el.textContent = value;
    });
  }

  function updateProjectNav() {
    const nav = $("projectNav");
    if (!nav || !State.projects) return;
    let html = `
    <span class="nav-link project-link ${
      !State.projectFilter ? "active" : ""
    }"
  data-project="" onclick="selectProject(null)">
  <i class="fas fa-folder w-5"></i> All Projects
  </span>
  `;
    State.projects.forEach((project) => {
      const isActive = State.projectFilter === project.id;
      html += `
    <span class="nav-link project-link ${isActive ? "active" : ""}"
    data-project="${project.id}" onclick="selectProject('${project.id}')">
    <i class="fas fa-folder w-5"></i> ${escapeHtml(project.name)}
    </span>
    `;
    });
    nav.innerHTML = html;
  }

  function initDragAndDrop() {
    const taskCards = $$(".task-card");
    const taskLists = $$(".task-list");
    const boardColumns = $$(".board-column");
    taskCards.forEach((card) => {
      card.addEventListener("dragstart", handleDragStart);
      card.addEventListener("dragend", handleDragEnd);
      card.addEventListener("dragover", handleDragOverCard);
      card.addEventListener("drop", handleDropOnCard);
      card.addEventListener("dragleave", handleDragLeaveCard);
    });
    taskLists.forEach((list) => {
      list.addEventListener("dragover", handleDragOverList);
      list.addEventListener("drop", handleDrop);
      list.addEventListener("dragleave", handleDragLeaveList);
      list.addEventListener("dragenter", handleDragEnterList);
    });
    boardColumns.forEach((col) => {
      col.addEventListener("dragover", handleDragOverColumn);
      col.addEventListener("drop", handleDropOnColumn);
      col.addEventListener("dragleave", handleDragLeaveColumn);
      col.addEventListener("dragenter", handleDragEnterColumn);
    });
  }
  let currentDropTarget = null;

  function handleDragEnterColumn(e) {
    e.preventDefault();
    const column = e.currentTarget;
    const taskList = column.querySelector('.task-list');
    column.classList.add('drag-over');
    if (taskList) taskList.classList.add('drag-over');
    currentDropTarget = column;
  }

  function handleDragOverColumn(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
    const column = e.currentTarget;
    const taskList = column.querySelector('.task-list');
    column.classList.add('drag-over');
    if (taskList) taskList.classList.add('drag-over');
  }

  function handleDragLeaveColumn(e) {
    const column = e.currentTarget;
    if (!column.contains(e.relatedTarget)) {
      column.classList.remove('drag-over');
      const taskList = column.querySelector('.task-list');
      if (taskList) taskList.classList.remove('drag-over');
      if (currentDropTarget === column) currentDropTarget = null;
    }
  }

  function handleDropOnColumn(e) {
    e.preventDefault();
    e.stopPropagation();
    const column = e.currentTarget;
    column.classList.remove('drag-over');
    const taskList = column.querySelector('.task-list');
    if (taskList) taskList.classList.remove('drag-over');
    const taskId = e.dataTransfer.getData("text/plain");
    const newStatus = column.dataset.status;
    if (!taskId || !newStatus) {
      console.error('handleDropOnColumn: Missing taskId or newStatus', {
        taskId,
        newStatus
      });
      toast('Could not determine drop target', 'error');
      return;
    }
    const previousStatus = State.draggedTask?.dataset.status;
    const statusName = getStatusName(newStatus);
    OptimisticUI.apply(
      'moveTask', {
        taskId,
        newStatus,
        previousStatus
      },
      () => {
        if (State.draggedTask && taskList) {
          taskList.appendChild(State.draggedTask);
          State.draggedTask.dataset.status = newStatus;
        }
        updateColumnCounts();
      },
      () => {
        if (State.tasks) {
          const task = State.tasks.find(t => t.id === taskId);
          if (task) task.status = statusName;
        }
        if (State.cache?.tasks?.data) {
          const cachedTask = State.cache.tasks.data.find(t => t.id === taskId);
          if (cachedTask) cachedTask.status = statusName;
        }
        LocalCache.set('tasks', State.cache.tasks.data);
      },
      () => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .moveTaskToStatus(taskId, statusName, 0);
      })
    );
    currentDropTarget = null;
  }

  function handleDragEnterList(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.add('drag-over');
  }

  function handleDragOverList(e) {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = "move";
    e.currentTarget.classList.add('drag-over');
  }

  function handleDragLeaveList(e) {
    e.stopPropagation();
    if (!e.currentTarget.contains(e.relatedTarget)) {
      e.currentTarget.classList.remove('drag-over');
    }
  }

  function handleDragOverCard(e) {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = "move";
    const taskList = e.currentTarget.closest('.task-list');
    const boardColumn = e.currentTarget.closest('.board-column');
    if (taskList) taskList.classList.add("drag-over");
    if (boardColumn) boardColumn.classList.add("drag-over");
  }

  function handleDropOnCard(e) {
    e.preventDefault();
    e.stopPropagation();
    const boardColumn = e.currentTarget.closest('.board-column[data-status]');
    const taskList = e.currentTarget.closest('.task-list[data-status]');
    if (taskList) taskList.classList.remove("drag-over");
    if (boardColumn) boardColumn.classList.remove("drag-over");
    const taskId = e.dataTransfer.getData("text/plain");
    let newStatus = boardColumn?.dataset.status || taskList?.dataset.status || e.currentTarget.dataset.status;
    if (!taskId || !newStatus) {
      console.error('handleDropOnCard: Missing taskId or newStatus', {
        taskId,
        newStatus
      });
      toast('Could not determine drop target', 'error');
      return;
    }
    if (taskId === e.currentTarget.dataset.taskId) {
      return;
    }
    const previousStatus = State.draggedTask?.dataset.status;
    const targetList = taskList || boardColumn?.querySelector('.task-list');
    const statusName = getStatusName(newStatus);
    OptimisticUI.apply(
      'moveTask', {
        taskId,
        newStatus,
        previousStatus
      },
      () => {
        if (State.draggedTask && targetList) {
          targetList.appendChild(State.draggedTask);
          State.draggedTask.dataset.status = newStatus;
        }
        updateColumnCounts();
      },
      () => {
        if (State.tasks) {
          const task = State.tasks.find(t => t.id === taskId);
          if (task) task.status = statusName;
        }
        if (State.cache?.tasks?.data) {
          const cachedTask = State.cache.tasks.data.find(t => t.id === taskId);
          if (cachedTask) cachedTask.status = statusName;
        }
        LocalCache.set('tasks', State.cache.tasks.data);
      },
      () => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .moveTaskToStatus(taskId, statusName, 0);
      })
    );
  }

  function handleDragLeaveCard(e) {
    e.stopPropagation();
    const taskList = e.currentTarget.closest('.task-list');
    const boardColumn = e.currentTarget.closest('.board-column');
    if (boardColumn && !boardColumn.contains(e.relatedTarget)) {
      if (taskList) taskList.classList.remove("drag-over");
      boardColumn.classList.remove("drag-over");
    }
  }

  function handleDragStart(e) {
    State.draggedTask = e.target;
    e.target.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", e.target.dataset.taskId);
    setTimeout(() => {
      if (State.draggedTask) {
        State.draggedTask.style.opacity = '0.4';
      }
    }, 0);
  }

  function handleDragEnd(e) {
    e.target.classList.remove("dragging");
    e.target.style.opacity = '';
    State.draggedTask = null;
    currentDropTarget = null;
    $$(".task-list").forEach((list) => list.classList.remove("drag-over"));
    $$(".board-column").forEach((col) => col.classList.remove("drag-over"));
  }

  function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove("drag-over");
    const taskId = e.dataTransfer.getData("text/plain");
    let newStatus = e.currentTarget.dataset.status;
    if (!newStatus) {
      const taskList = e.target.closest('.task-list[data-status]');
      if (taskList) {
        newStatus = taskList.dataset.status;
      }
    }
    if (!newStatus) {
      const boardColumn = e.target.closest('.board-column[data-status]');
      if (boardColumn) {
        newStatus = boardColumn.dataset.status;
      }
    }
    if (!newStatus) {
      const taskCard = e.target.closest('.task-card[data-status]');
      if (taskCard) {
        newStatus = taskCard.dataset.status;
      }
    }
    if (!taskId || !newStatus) {
      console.error('handleDrop: Missing taskId or newStatus', {
        taskId,
        newStatus
      });
      toast('Could not determine drop target', 'error');
      return;
    }
    let targetList = e.currentTarget;
    if (!targetList.classList.contains('task-list')) {
      targetList = e.target.closest('.task-list[data-status]');
      if (!targetList) {
        const boardColumn = e.target.closest('.board-column[data-status]');
        if (boardColumn) {
          targetList = boardColumn.querySelector('.task-list');
        }
      }
    }
    const previousStatus = State.draggedTask?.dataset.status;
    const statusName = getStatusName(newStatus);
    OptimisticUI.apply(
      'moveTask', {
        taskId,
        newStatus,
        previousStatus
      },
      () => {
        if (State.draggedTask && targetList) {
          targetList.appendChild(State.draggedTask);
          State.draggedTask.dataset.status = newStatus;
        }
        updateColumnCounts();
      },
      () => {
        if (State.tasks) {
          const task = State.tasks.find(t => t.id === taskId);
          if (task) task.status = statusName;
        }
        if (State.cache?.tasks?.data) {
          const cachedTask = State.cache.tasks.data.find(t => t.id === taskId);
          if (cachedTask) cachedTask.status = statusName;
        }
        LocalCache.set('tasks', State.cache.tasks.data);
      },
      () => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .moveTaskToStatus(taskId, statusName, 0);
      })
    );
  }

  function getStatusName(statusId) {
    const statusMap = {
      'backlog': 'Backlog',
      'to_do': 'To Do',
      'in_progress': 'In Progress',
      'review': 'Review',
      'testing': 'Testing',
      'done': 'Done'
    };
    return statusMap[statusId] || statusId;
  }

  function openTaskModal(taskId) {
    if (taskId) {
      google.script.run
        .withSuccessHandler((task) => {
          State.editingTask = task;
          populateTaskModal(task);
          show($("taskModal"));
        })
        .withFailureHandler(handleError)
        .loadTask(taskId);
    } else {
      State.editingTask = null;
      resetTaskForm();
      show($("taskModal"));
    }
  }

  function closeTaskModal() {
    hide($("taskModal"));
    State.editingTask = null;
  }

  function populateTaskModal(task) {
    if (!task) return;
    const fields = [
      "taskTitle",
      "taskDescription",
      "taskStatus",
      "taskPriority",
      "taskType",
      "taskProject",
      "taskAssignee",
      "taskDueDate",
      "taskStartDate",
      "taskEstimatedHrs",
      "taskStoryPoints",
    ];
    fields.forEach((field) => {
      const el = $(field);
      if (el) {
        const key = field.replace("task", "").toLowerCase();
        el.value = task[key] || "";
      }
    });
    $("modalTitle").textContent = `Edit Task: ${task.id}`;
  }

  function resetTaskForm() {
    const form = $("taskForm");
    if (form) form.reset();
    $("modalTitle").textContent = "New Task";
    populateSelectOptions();
  }

  function saveTask(e) {
    e.preventDefault();
    const taskData = {
      title: $("taskTitle").value,
      description: $("taskDescription").value,
      status: $("taskStatus").value,
      priority: $("taskPriority").value,
      type: $("taskType").value,
      projectId: $("taskProject").value,
      assignee: $("taskAssignee").value,
      dueDate: $("taskDueDate").value,
      startDate: $("taskStartDate").value,
      estimatedHrs: parseFloat($("taskEstimatedHrs").value) || 0,
      storyPoints: parseInt($("taskStoryPoints").value) || 0,
    };
    showLoading(true);
    if (State.editingTask) {
      google.script.run
        .withSuccessHandler(async () => {
          closeTaskModal();
          await refreshAllData();
          loadBoard();
          toast("Task updated", "success");
        })
        .withFailureHandler(handleError)
        .saveTaskUpdate(State.editingTask.id, taskData);
    } else {
      google.script.run
        .withSuccessHandler(async () => {
          closeTaskModal();
          await refreshAllData();
          loadBoard();
          toast("Task created", "success");
        })
        .withFailureHandler(handleError)
        .saveNewTask(taskData);
    }
  }

  function deleteTask() {
    if (!State.editingTask) return;
    if (!confirm("Are you sure you want to delete this task?")) return;
    showLoading(true);
    google.script.run
      .withSuccessHandler(async () => {
        closeTaskModal();
        await refreshAllData();
        loadBoard();
        toast("Task deleted", "success");
      })
      .withFailureHandler(handleError)
      .removeTask(State.editingTask.id);
  }

  function openProjectModal() {
    show($("projectModal"));
  }

  function closeProjectModal() {
    hide($("projectModal"));
  }

  function saveProject(e) {
    e.preventDefault();
    const projectData = {
      name: $("projectName").value,
      description: $("projectDescription").value,
    };
    showLoading(true);
    google.script.run
      .withSuccessHandler(() => {
        closeProjectModal();
        loadBoard();
        toast("Project created", "success");
      })
      .withFailureHandler(handleError)
      .saveNewProject(projectData);
  }

  function show(el) {
    if (el) el.classList.remove("hidden");
  }

  function hide(el) {
    if (el) el.classList.add("hidden");
  }

  function showLoading(show) {
    State.loading = show;
    const overlay = $("loadingOverlay");
    if (overlay) {
      if (show) {
        overlay.classList.remove("hidden");
      } else {
        overlay.classList.add("hidden");
      }
    }
  }

  function toast(message, type = "info") {
    const container = $("toastContainer");
    if (!container) return;
    const t = document.createElement("div");
    t.className = `toast ${type}`;
    const icons = {
      success: "fa-check-circle",
      error: "fa-exclamation-circle",
      warning: "fa-exclamation-triangle",
      info: "fa-info-circle",
    };
    t.innerHTML = `<i class="fas ${
    icons[type] || icons.info
  }"></i><span>${escapeHtml(message)}</span>`;
    container.appendChild(t);
    requestAnimationFrame(() => t.classList.add("show"));
    setTimeout(() => {
      t.classList.remove("show");
      setTimeout(() => t.remove(), 300);
    }, 3000);
  }

  function handleError(error) {
    console.error("Error:", error);
    showLoading(false);
    toast((error && error.message) || "An error occurred", "error");
  }

  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function getInitials(name) {
    if (!name) return "?";
    return name
      .split(/[\s@]/)
      .filter(Boolean)
      .map((w) => w[0])
      .slice(0, 2)
      .join("")
      .toUpperCase();
  }

  function formatRelativeTime(timestamp) {
    if (!timestamp) return "";
    try {
      const d = new Date(timestamp);
      const now = new Date();
      const diff = now - d;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (minutes < 1) return "just now";
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return d.toLocaleDateString();
    } catch {
      return "";
    }
  }

  function getStatusBadgeClass(status) {
    const classes = {
      Backlog: "bg-gray-100 text-gray-800",
      "To Do": "bg-blue-100 text-blue-800",
      "In Progress": "bg-yellow-100 text-yellow-800",
      Review: "bg-purple-100 text-purple-800",
      Testing: "bg-indigo-100 text-indigo-800",
      Done: "bg-green-100 text-green-800",
    };
    return classes[status] || "bg-gray-100 text-gray-800";
  }
  async function init() {
    const localBoard = LocalCache.get('board');
    const localConfig = LocalCache.get('config');
    const localUser = LocalCache.get('user');
    const localTasks = LocalCache.get('tasks');
    const localProjects = LocalCache.get('projects');
    if (localBoard && localUser && localTasks) {
      State.user = localUser;
      State.board = localBoard;
      State.projects = localProjects || localBoard.projects || [];
      State.users = localBoard.users || [];
      State.config = localConfig || localBoard.config;
      State.setTasks(localTasks);
      State.setProjects(State.projects);
      if (State.board && State.config) State.board.config = State.config;
      showLoading(false);
      updateUserDisplay();
      if (State.config) populateFormOptions(State.config);
      renderBoard();
      updateStats();
      updateProjectNav();
      SyncManager.init();
      setTimeout(() => fetchFreshDataInBackground(), 100);
      return;
    }
    showLoading(true);
    let hasCachedData = false;
    if (typeof CacheService !== 'undefined') {
      try {
        await CacheService.init();
        const [cachedBoard, cachedConfig, cachedUser] = await Promise.all([
          CacheService.get('boardData'),
          CacheService.get('config'),
          CacheService.get('userData')
        ]);
        if (cachedBoard && cachedConfig && cachedUser) {
          hasCachedData = true;
          State.user = cachedUser;
          State.board = cachedBoard;
          State.projects = cachedBoard.projects || [];
          State.users = cachedBoard.users || [];
          State.config = cachedConfig;
          if (State.board) State.board.config = cachedConfig;
          LocalCache.set('board', cachedBoard);
          LocalCache.set('config', cachedConfig);
          LocalCache.set('user', cachedUser);
          LocalCache.set('tasks', State.cache.tasks.data || []);
          LocalCache.set('projects', State.projects);
          showLoading(false);
          updateUserDisplay();
          populateFormOptions(cachedConfig);
          renderBoard();
          updateStats();
          updateProjectNav();
          SyncManager.init();
          setTimeout(() => fetchFreshDataInBackground(), 500);
          return;
        }
      } catch (cacheErr) {
        console.warn('Cache load failed:', cacheErr);
      }
    }
    const initTimeout = setTimeout(() => {
      console.error("❌ Timeout after 15 seconds");
      showLoading(false);
      toast("Loading timed out. Please refresh.", "error");
      LoginModal.show();
    }, 15000);
    try {
      loadExternalLibraries().catch(err => console.warn('Library load warning:', err));
      google.script.run
        .withSuccessHandler((data) => {
          clearTimeout(initTimeout);
          handleInitialData(data);
        })
        .withFailureHandler((error) => {
          clearTimeout(initTimeout);
          handleInitError(error);
        })
        .getInitialDataFast();
    } catch (error) {
      clearTimeout(initTimeout);
      console.error("❌ Init error:", error);
      showLoading(false);
      toast("Initialization failed", "error");
      LoginModal.show();
    }
  }

  function handleInitialData(data) {
    user: data.user?.email,
    taskCount: data.board?.columns?.reduce((sum, col) => sum + (col.tasks?.length || 0), 0)
  });
  try {
    State.user = data.user;
    State.board = data.board;
    State.projects = data.board?.projects || [];
    State.users = data.board?.users || [];
    State.config = data.config;
    if (State.board && data.config) {
      State.board.config = data.config;
    }
    const flatTasks = [];
    if (data.board?.columns) {
      data.board.columns.forEach(col => {
        if (col.tasks) {
          col.tasks.forEach(task => {
            flatTasks.push({
              ...task,
              status: col.name || col.id
            });
          });
        }
      });
    }
    State.setTasks(flatTasks);
    State.setProjects(data.board?.projects || []);
    State.setUsers(data.board?.users || []);
    LocalCache.set('board', data.board);
    LocalCache.set('config', data.config);
    LocalCache.set('user', data.user);
    LocalCache.set('tasks', flatTasks);
    LocalCache.set('projects', data.board?.projects || []);
    if (typeof CacheService !== 'undefined') {
      Promise.all([
        CacheService.set('boardData', data.board),
        CacheService.set('config', data.config),
        CacheService.set('userData', data.user),
        CacheService.set('tasks', flatTasks),
        CacheService.set('projects', data.board?.projects || []),
        CacheService.set('users', data.board?.users || [])
      ]).then(() => {}).catch(err => {
        console.warn('IndexedDB cache failed:', err);
      });
    }
    updateUserDisplay();
    populateFormOptions(data.config);
    showLoading(false);
    try {
      renderBoard();
    } catch (renderError) {
      console.error("❌ Error rendering board:", renderError);
      toast("Error rendering board. Please refresh.", "error");
    }
    try {
      updateStats();
    } catch (statsError) {
      console.error("❌ Error updating stats:", statsError);
    }
    try {
      updateProjectNav();
    } catch (navError) {
      console.error("❌ Error updating project nav:", navError);
    }
    try {
      SyncManager.init();
    } catch (syncError) {
      console.warn("⚠️ SyncManager init failed:", syncError);
    }
  } catch (error) {
    console.error("❌ Critical error in handleInitialData:", error);
    showLoading(false);
    toast("Error initializing app: " + error.message, "error");
    setTimeout(() => {
      if (!State.user) {
        LoginModal.show();
      }
    }, 1000);
  }
  }

  function handleInitError(error) {
    console.error("Init error:", error);
    showLoading(false);
    const errorMessage = error && error.message ? error.message.toLowerCase() : "";
    State.user = null;
    State.board = null;
    if (
      errorMessage.includes("login") ||
      errorMessage.includes("session") ||
      errorMessage.includes("authenticated") ||
      errorMessage.includes("no active") ||
      errorMessage.includes("user not found") ||
      !errorMessage
    ) {
      LoginModal.show();
    } else {
      console.warn("Unexpected init error, showing login modal as fallback:", errorMessage);
      toast("Session error. Please login.", "warning");
      setTimeout(() => {
        LoginModal.show();
      }, 500);
    }
  }

  function updateUserDisplay() {
    if (!State.user) return;
    const avatar = $("userAvatar");
    const name = $("userName");
    const email = $("userEmail");
    if (avatar)
      avatar.textContent = getInitials(State.user.name || State.user.email);
    if (name) name.textContent = State.user.name || State.user.email;
    if (email) email.textContent = State.user.email;
  }

  function populateFormOptions(config) {
    if (!config) return;
    State.config = config;
    if (!State.board) State.board = {};
    State.board.config = config;
    if (typeof CacheService !== 'undefined') {
      CacheService.set('config', config);
    }
    const statusSelect = $("taskStatus");
    if (statusSelect && config.statuses) {
      statusSelect.innerHTML = config.statuses
        .map((s) => `<option value="${s}">${s}</option>`)
        .join("");
    }
    const prioritySelect = $("taskPriority");
    if (prioritySelect && config.priorities) {
      prioritySelect.innerHTML = config.priorities
        .map(
          (p) =>
          `<option value="${p}" ${
      p === "Medium" ? "selected" : ""
    }>${p}</option>`
        )
        .join("");
    }
    const typeSelect = $("taskType");
    if (typeSelect && config.types) {
      typeSelect.innerHTML = config.types
        .map((t) => `<option value="${t}">${t}</option>`)
        .join("");
    }
    const projectSelect = $("taskProject");
    if (projectSelect && State.projects) {
      projectSelect.innerHTML =
        '<option value="">No Project</option>' +
        State.projects
        .map((p) => `<option value="${p.id}">${escapeHtml(p.name)}</option>`)
        .join("");
    }
    const assigneeSelect = $("taskAssignee");
    if (assigneeSelect && State.users) {
      assigneeSelect.innerHTML =
        '<option value="">Unassigned</option>' +
        State.users
        .map(
          (u) =>
          `<option value="${u.email}">${escapeHtml(
      u.name || u.email
      )}</option>`
        )
        .join("");
    }
  }

  function populateSelectOptions() {
    if (State.config) {
      populateFormOptions(State.config);
    } else {
      console.warn('State.config not available, cannot populate select options');
    }
  }

  function showLoginForm() {
    LoginModal.show();
  }

  function handleLogout() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(() => {
        showLoading(false);
        State.user = null;
        State.board = null;
        State.projects = [];
        State.users = [];
        const avatar = $("userAvatar");
        const name = $("userName");
        const email = $("userEmail");
        if (avatar) avatar.textContent = "?";
        if (name) name.textContent = "Not logged in";
        if (email) email.textContent = "";
        const board = $("board");
        if (board) board.innerHTML = "";
        LoginModal.show();
        toast("You have been logged out", "info");
      })
      .withFailureHandler((error) => {
        showLoading(false);
        handleError(error);
      })
      .logout();
  }
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") {
      if (typeof TaskDetailPanel !== 'undefined' && TaskDetailPanel.isOpen) {
        TaskDetailPanel.close();
        return;
      }
      closeTaskModal();
      closeProjectModal();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === "n") {
      e.preventDefault();
      openTaskModal();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === "/") {
      e.preventDefault();
      const searchInput = $("searchInput");
      if (searchInput) searchInput.focus();
    }
  });
  document.addEventListener("DOMContentLoaded", init);
</script>